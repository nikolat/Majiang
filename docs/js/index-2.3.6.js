(()=>{"use strict";var i={4835:(i,e,t)=>{t.d(e,{B0:()=>l,B_:()=>d,Q7:()=>r,_P:()=>o});const a="http://localhost:9801",s=!0;async function h(i){const e=["NOTIFY SSTP/1.1","Charset: UTF-8","SecurityLevel: external","Sender: Majiang","Event: OnMahjong","Option: nobreak",`ReceiverGhostHWnd: ${i[0]}`,"Reference0: UKAJONG/0.2"];for(let t=1;t<i.length;t++)e.push(`Reference${t}: ${i[t]}`);e.push(""),e.push("");const t=await n(a+"/api/sstp/v1",e.join("\n"));s&&console.log(e.join("\n"),"\n----------\n",t,"\n----------\n")}async function n(i="",e=""){const t={method:"POST",headers:{"Content-Type":"text/plain",Origin:a},body:e};try{return(await fetch(i,t)).text()}catch(i){return console.log(i),""}}async function l(){const i=["EXECUTE SSTP/1.1","Charset: UTF-8","SecurityLevel: external","Command: GetFMO","",""],e=await n(a+"/api/sstp/v1",i.join("\n"));s&&console.log(i.join("\n"),"\n----------\n",e,"\n----------\n");const t=e.split("\r\n"),h=[],l=[];for(let i=0;i<t.length;i++)if(t[i].indexOf(".hwnd"+String.fromCharCode(1))>=0){const e=t[i].split(String.fromCharCode(1))[1].replace("\r","");h.push(e)}else if(t[i].indexOf(".name"+String.fromCharCode(1))>=0){const e=t[i].split(String.fromCharCode(1))[1].replace("\r","");l.push(e)}const o=[],r=[],d={};for(let i=0;i<l.length;i++){d[l[i]]=h[i];const e=["NOTIFY SSTP/1.1","Charset: UTF-8","SecurityLevel: external","Sender: Majiang","Event: OnMahjong","Option: nobreak",`ReceiverGhostHWnd: ${h[i]}`,"Reference0: UKAJONG/0.2","Reference1: hello","",""],t=await n(a+"/api/sstp/v1",e.join("\n"));s&&console.log(e.join("\n"),"\n----------\n",t,"\n----------\n");const _=t.split("\r\n");for(let i=0;i<_.length;i++)if(_[i].indexOf("X-SSTP-PassThru-Reference3: name=")>=0){const e=_[i].split("X-SSTP-PassThru-Reference3: name=")[1].replace("\r","");r.push(e),o.push(d[e])}}return[r,o]}class o extends Majiang.Game{constructor(i,e,t,a,s,h){super(i,e,t,a);for(let i=0;i<s.length;i++){let e=(i+1)%4;if(this._model.player[e]=s[i],this._players[e]._hwnd=h[i],3==i)break}}async reply_zimo(){let i=this._model,e=this.get_reply(i.lunban);if(e.daopai){if(this.allow_pingju()){let e=["","","",""];return e[i.lunban]=i.shoupai[i.lunban].toString(),this.delay((()=>this.pingju("九種九牌",e)),0)}}else if(e.hule){if(this.allow_hule()){this._view&&this._view.say("zimo",i.lunban);for(let i=0;i<4;i++)this._players[i]._hwnd&&await h([this._players[i]._hwnd,"say",this._model.player[this._model.player_id[this._model.lunban]],"tsumo"]);return this.delay((()=>this.hule()))}}else if(e.gang){if(this.get_gang_mianzi().find((i=>i==e.gang))){this._view&&this._view.say("gang",i.lunban);for(let i=0;i<4;i++)this._players[i]._hwnd&&await h([this._players[i]._hwnd,"say",this._model.player[this._model.player_id[this._model.lunban]],"kan"]);return this.delay((()=>this.gang(e.gang)))}}else if(e.dapai){let t=e.dapai.replace(/\*$/,"");if(this.get_dapai().find((i=>i==t))){if("*"==e.dapai.substr(-1)&&this.allow_lizhi(t)){this._view&&this._view.say("lizhi",i.lunban);for(let i=0;i<4;i++)this._players[i]._hwnd&&await h([this._players[i]._hwnd,"say",this._model.player[this._model.player_id[this._model.lunban]],"richi"]);return this.delay((()=>this.dapai(e.dapai)))}return this.delay((()=>this.dapai(t)),0)}}let t=this.get_dapai().pop();this.delay((()=>this.dapai(t)),0)}async reply_dapai(){let i=this._model;for(let e=1;e<4;e++){let t=(i.lunban+e)%4;if(this.get_reply(t).hule&&this.allow_hule(t)){if(1==this._rule["最大同時和了数"]&&this._hule.length)continue;this._view&&this._view.say("rong",t);for(let i=0;i<4;i++)this._players[i]._hwnd&&await h([this._players[i]._hwnd,"say",this._model.player[this._model.player_id[t]],"ron"]);this._hule.push(t)}else{let e=i.shoupai[t].clone().zimo(this._dapai);-1==Majiang.Util.xiangting(e)&&(this._neng_rong[t]=!1)}}if(3==this._hule.length&&2==this._rule["最大同時和了数"]){let e=["","","",""];for(let t of this._hule)e[t]=i.shoupai[t].toString();return this.delay((()=>this.pingju("三家和",e)))}if(this._hule.length)return this.delay((()=>this.hule()));if("*"==this._dapai.substr(-1)&&(i.defen[i.player_id[i.lunban]]-=1e3,i.lizhibang++,4==this._lizhi.filter((i=>i)).length&&this._rule["途中流局あり"])){let e=i.shoupai.map((i=>i.toString()));return this.delay((()=>this.pingju("四家立直",e)))}if(this._diyizimo&&3==i.lunban&&(this._diyizimo=!1,this._fengpai))return this.delay((()=>this.pingju("四風連打")),0);if(4==this._n_gang.reduce(((i,e)=>i+e))&&Math.max(...this._n_gang)<4&&this._rule["途中流局あり"])return this.delay((()=>this.pingju("四開槓")),0);if(!i.shan.paishu){let i=["","","",""];for(let e=0;e<4;e++){let t=this.get_reply(e);t.daopai&&(i[e]=t.daopai)}return this.delay((()=>this.pingju("",i)),0)}for(let e=1;e<4;e++){let t=(i.lunban+e)%4,a=this.get_reply(t);if(a.fulou){let i=a.fulou.replace(/0/g,"5");if(i.match(/^[mpsz](\d)\1\1\1/)){if(this.get_gang_mianzi(t).find((i=>i==a.fulou))){this._view&&this._view.say("gang",t);for(let i=0;i<4;i++)this._players[i]._hwnd&&await h([this._players[i]._hwnd,"say",this._model.player[this._model.player_id[t]],"kan"]);return this.delay((()=>this.fulou(a.fulou)))}}else if(i.match(/^[mpsz](\d)\1\1/)&&this.get_peng_mianzi(t).find((i=>i==a.fulou))){this._view&&this._view.say("peng",t);for(let i=0;i<4;i++)this._players[i]._hwnd&&await h([this._players[i]._hwnd,"say",this._model.player[this._model.player_id[t]],"pon"]);return this.delay((()=>this.fulou(a.fulou)))}}}let e=(i.lunban+1)%4,t=this.get_reply(e);if(t.fulou&&this.get_chi_mianzi(e).find((i=>i==t.fulou))){this._view&&this._view.say("chi",e);for(let i=0;i<4;i++)this._players[i]._hwnd&&await h([this._players[i]._hwnd,"say",this._model.player[this._model.player_id[e]],"chi"]);return this.delay((()=>this.fulou(t.fulou)))}this.delay((()=>this.zimo()),0)}}class r extends Majiang.UI.Player{constructor(i,e,t){super(i,e,t)}to_ump(i){let e="",t="";for(let a=0;a<i.length;a++){let s=i.substring(a,a+1);s.match(/[_\*\-+=]/)||(s.match(/\d/)?e+=s.replace(/0/,"5")+t:t=s)}return e}from_ump(i){let e="",t="",a=-1;for(let s=0;s<i.length;s++){let h=i.substring(s,s+1);h.match(/\d/)?a=1*h:h.match(/[mpsz]/)&&(t==h?e+=a:(t=h,e+=t+a))}return e}replace_zero_if_none(i){let e=i;return"m5"==i&&0==this.shoupai._bingpai.m[5]?e="m0":"p5"==i&&0==this.shoupai._bingpai.p[5]?e="p0":"s5"==i&&0==this.shoupai._bingpai.s[5]&&(e="s0"),e}async kaiju(i){super.kaiju(i),this._hwnd&&await h([this._hwnd,"gamestart",["東","南","西","北"][(4+this._id-i.qijia)%4],i.player[0],i.player[1],i.player[2],i.player[3]])}async qipai(i){super.qipai(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&(await h([this._hwnd,"kyokustart",["東","南","西","北"][i.zhuangfeng],t[this._model.qijia],i.changbang,1e3*i.lizhibang]),await h([this._hwnd,"dora",this.to_ump(i.baopai)]),await h([this._hwnd,"haipai",this._model.player[this._id],this.to_ump(this.shoupai.toString())]))}async zimo(i,e){super.zimo(i,e);const t=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,a=[this._model.player[(4-t)%4],this._model.player[(5-t)%4],this._model.player[(6-t)%4],this._model.player[(7-t)%4]];this._hwnd&&i.l==this._model.menfeng(this._id)&&await h([this._hwnd,"tsumo",a[(this._model.qijia+i.l)%4],this.shan.paishu,this.to_ump(i.p)])}async dapai(i){super.dapai(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&await h([this._hwnd,"sutehai",t[(this._model.qijia+i.l)%4],this.to_ump(i.p)])}async fulou(i){super.fulou(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&await h([this._hwnd,"open",t[(this._model.qijia+i.l)%4],this.to_ump(i.m)])}async gang(i){super.gang(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&(i.m.match(/^[mpsz]\d{4}/)?await h([this._hwnd,"open",t[(this._model.qijia+i.l)%4],this.to_ump(i.m)]):await h([this._hwnd,"open",t[(this._model.qijia+i.l)%4],this.to_ump(i.m.substr(0,2))]))}async kaigang(i){super.kaigang(i),this._hwnd&&await h([this._hwnd,"dora",this.to_ump(i.baopai)])}async hule(i){super.hule(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];if(this._hwnd){await h([this._hwnd,"agari",t[(i.l+this._model.qijia)%4],i.fu]),i.fubaopai&&await h([this._hwnd,"dora",this.to_ump(i.fubaopai.join(""))]);for(let e=0;e<4;e++)i.fenpei[e]&&await h([this._hwnd,"point",t[(e+this._model.qijia)%4],i.fenpei[e]>0?"+":"-",Math.abs(i.fenpei[e])]);await h([this._hwnd,"kyokuend"])}}async pingju(i){super.pingju(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];if(this._hwnd){await h([this._hwnd,"ryukyoku"]);for(let e=0;e<4;e++)i.fenpei[e]&&await h([this._hwnd,"point",t[(e+this._model.qijia)%4],i.fenpei[e]>0?"+":"-",Math.abs(i.fenpei[e])]);await h([this._hwnd,"kyokuend"])}}async jieju(i){super.jieju(i);const e=this._model.player;this._hwnd&&await h([this._hwnd,"gameend",e[0]+String.fromCharCode(1)+i.defen[0],e[1]+String.fromCharCode(1)+i.defen[1],e[2]+String.fromCharCode(1)+i.defen[2],e[3]+String.fromCharCode(1)+i.defen[3]])}}class d extends Majiang.AI{to_ump(i){let e="",t="";for(let a=0;a<i.length;a++){let s=i.substring(a,a+1);s.match(/[_\*\-+=]/)||(s.match(/\d/)?e+=s.replace(/0/,"5")+t:t=s)}return e}from_ump(i){let e="",t="",a=-1;for(let s=0;s<i.length;s++){let h=i.substring(s,s+1);h.match(/\d/)?a=1*h:h.match(/[mpsz]/)&&(t==h?e+=a:(t=h,e+=t+a))}return e}replace_zero_if_none(i){let e=i;return"m5"==i&&0==this.shoupai._bingpai.m[5]?e="m0":"p5"==i&&0==this.shoupai._bingpai.p[5]?e="p0":"s5"==i&&0==this.shoupai._bingpai.s[5]&&(e="s0"),e}async action_zimo(i,e){if(i.l!=this._menfeng)return this._callback();let t;this.select_hule(null,e)?this._callback({hule:"-"}):this.select_pingju()?this._callback({daopai:"-"}):(t=this.select_gang())?this._callback({gang:t}):this._callback({dapai:await this.select_dapai()})}async action_fulou(i){return i.l!=this._menfeng||i.m.match(/^[mpsz]\d{4}/)?this._callback():void this._callback({dapai:await this.select_dapai()})}async select_dapai(i){let e;if(this._hwnd){let[i,t]=await async function(i){const e=["NOTIFY SSTP/1.1","Charset: UTF-8","SecurityLevel: external","Sender: Majiang","Event: OnMahjong","Option: nobreak",`ReceiverGhostHWnd: ${i[0]}`,"Reference0: UKAJONG/0.2","Reference1: sutehai?","",""],t=await n(a+"/api/sstp/v1",e.join("\n")),h=t.split("\r\n");let l,o;for(let i=0;i<h.length;i++)h[i].indexOf("X-SSTP-PassThru-Reference2: ")>=0?l=h[i].split("X-SSTP-PassThru-Reference2: ")[1].replace("\r",""):h[i].indexOf("X-SSTP-PassThru-Reference3: ")>=0&&(o=h[i].split("X-SSTP-PassThru-Reference3: ")[1].replace("\r",""));return s&&console.log(e.join("\n"),"\n----------\n",t,"\n----------\n"),[l,o]}([this._hwnd]);void 0!==t&&(t=this.from_ump(t),t==this.shoupai._zimo&&(t+="_"),"richi"==i&&(t+="*")),e=t}return super.select_dapai(i)}async kaiju(i){super.kaiju(i),this._hwnd&&await h([this._hwnd,"gamestart",["東","南","西","北"][(4+this._id-i.qijia)%4],i.player[0],i.player[1],i.player[2],i.player[3]])}async qipai(i){super.qipai(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&(await h([this._hwnd,"kyokustart",["東","南","西","北"][i.zhuangfeng],t[this._model.qijia],i.changbang,1e3*i.lizhibang]),await h([this._hwnd,"dora",this.to_ump(i.baopai)]),await h([this._hwnd,"haipai",this._model.player[this._id],this.to_ump(this.shoupai.toString())]))}async zimo(i,e){super.zimo(i,e);const t=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,a=[this._model.player[(4-t)%4],this._model.player[(5-t)%4],this._model.player[(6-t)%4],this._model.player[(7-t)%4]];this._hwnd&&i.l==this._model.menfeng(this._id)&&await h([this._hwnd,"tsumo",a[(this._model.qijia+i.l)%4],this.shan.paishu,this.to_ump(i.p)])}async dapai(i){super.dapai(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&await h([this._hwnd,"sutehai",t[(this._model.qijia+i.l)%4],this.to_ump(i.p)])}async fulou(i){super.fulou(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&await h([this._hwnd,"open",t[(this._model.qijia+i.l)%4],this.to_ump(i.m)])}async gang(i){super.gang(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];this._hwnd&&(i.m.match(/^[mpsz]\d{4}/)?await h([this._hwnd,"open",t[(this._model.qijia+i.l)%4],this.to_ump(i.m)]):await h([this._hwnd,"open",t[(this._model.qijia+i.l)%4],this.to_ump(i.m.substr(0,2))]))}async kaigang(i){super.kaigang(i),this._hwnd&&await h([this._hwnd,"dora",this.to_ump(i.baopai)])}async hule(i){super.hule(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];if(this._hwnd){await h([this._hwnd,"agari",t[(i.l+this._model.qijia)%4],i.fu]),i.fubaopai&&await h([this._hwnd,"dora",this.to_ump(i.fubaopai.join(""))]);for(let e=0;e<4;e++)i.fenpei[e]&&await h([this._hwnd,"point",t[(e+this._model.qijia)%4],i.fenpei[e]>0?"+":"-",Math.abs(i.fenpei[e])]);await h([this._hwnd,"kyokuend"])}}async pingju(i){super.pingju(i);const e=(4+this._model.menfeng(this._id)-this._id+this._model.qijia)%4,t=[this._model.player[(4-e)%4],this._model.player[(5-e)%4],this._model.player[(6-e)%4],this._model.player[(7-e)%4]];if(this._hwnd){await h([this._hwnd,"ryukyoku"]);for(let e=0;e<4;e++)i.fenpei[e]&&await h([this._hwnd,"point",t[(e+this._model.qijia)%4],i.fenpei[e]>0?"+":"-",Math.abs(i.fenpei[e])]);await h([this._hwnd,"kyokuend"])}}async jieju(i){super.jieju(i);const e=this._model.player;this._hwnd&&await h([this._hwnd,"gameend",e[0]+String.fromCharCode(1)+i.defen[0],e[1]+String.fromCharCode(1)+i.defen[1],e[2]+String.fromCharCode(1)+i.defen[2],e[3]+String.fromCharCode(1)+i.defen[3]])}}}},e={};function t(a){var s=e[a];if(void 0!==s)return s.exports;var h=e[a]={exports:{}};return i[a](h,h.exports,t),h.exports}t.d=(i,e)=>{for(var a in e)t.o(e,a)&&!t.o(i,a)&&Object.defineProperty(i,a,{enumerable:!0,get:e[a]})},t.o=(i,e)=>Object.prototype.hasOwnProperty.call(i,e),(()=>{var i=t(4835);
/*!
 *  電脳麻将 v2.3.6
 *
 *  Copyright(C) 2017 Satoshi Kobayashi
 *  Released under the MIT license
 *  https://github.com/kobalab/Majiang/blob/master/LICENSE
 */const{hide:e,show:a,fadeIn:s,scale:h,setSelector:n,clearSelector:l}=Majiang.UI.Util;let o;$((function(){let t;const r=Majiang.UI.pai($("#loaddata")),d=Majiang.UI.audio($("#loaddata")),_=i=>($("body").addClass("analyzer"),new Majiang.UI.Analyzer($("#board > .analyzer"),i,r,(()=>$("body").removeClass("analyzer")))),p=new Majiang.UI.PaipuFile($("#file"),"Majiang.game",(i=>($("#board .controller").addClass("paipu"),$("body").attr("class","board"),h($("#board"),$("#space")),new Majiang.UI.Paipu($("#board"),i,r,d,"Majiang.pref",(()=>s($("body").attr("class","file"))),_))),(i=>(s($("body").attr("class","stat")),new Majiang.UI.PaipuStat($("#stat"),i,(()=>s($("body").attr("class","file"))))))),u=Majiang.rule(JSON.parse(localStorage.getItem("Majiang.rule")||"{}"));async function m(){const[e,a]=await(0,i.B0)();let s=[new Majiang.UI.Player($("#board"),r,d)];for(let e=1;e<4;e++)s[e]=new i.B_;s[0]=new i.Q7($("#board"),r,d),t=new i._P(s,y,u,null,e,a),t.view=new Majiang.UI.Board($("#board .board"),r,d,t.model),$("#board .controller").removeClass("paipu"),$("body").attr("class","board"),h($("#board"),$("#space")),new Majiang.UI.GameCtl($("#board"),"Majiang.pref",t,t._view),t.kaiju()}function y(i){i&&p.add(i,10),s($("body").attr("class","file")),p.redraw()}$("#file .start").on("click",m),$(window).on("resize",(()=>h($("#board"),$("#space")))),$(window).on("load",(function(){e($("#title .loading")),$("#title .start").attr("tabindex",0).attr("role","button").on("click",(()=>{l("title"),p.isEmpty?m():y()})),a(n($("#title .start"),"title",{focus:null,touch:!1}))})),o&&$(window).trigger("load")})),$(window).on("load",(()=>o=!0))})()})();